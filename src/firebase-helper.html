<link rel="import" href="../bower_components/polymer/polymer.html">

<script>
// @polymerBehavior Polymer.FirebaseHelper

Polymer.FirebaseHelper = {
  _firebaseUpdateUserInfo: function(user) {
    this.set('_channels', []);

    if (!user)
      return;

    if (this.offline) {
      this.$.loading.hidden = true;
    }

    firebase.database().ref('/users/' + user.uid).once('value', function(snapshot) {
      var userInfo = snapshot.val();

      this.$.newPost.hidden = true;
      this.$.loading.hidden = true;
      this.$.pages.hidden = false;


      if (userInfo) {
        // console.log('Existing user:', this.user);

      } else {
        console.log('New user!');

        firebase.database().ref('/users/').child(user.uid)
            .set({
              id: user.uid,
              name: user.displayName,
              email: user.email,
              photo: user.photoURL,
              createdAt: {'.sv': 'timestamp'}
            });
      }
    }.bind(this));
  },

  _firebaseAddMessage: function(channel, message, activity, date, location) {
    // console.log(channel, message, activity, date, location);
    // Get the channel ref from the names -> keys mapping
    firebase.database().ref('/channels/' + channel).once('value', function(snapshot) {
      var now = new Date().getTime();

      firebase.database().ref('/posts/').child(channel)
        .push({
          name: this.user.displayName,
          activity: activity,
          date: date,
          message: message,
          email: this.user.email,
          uid: this.user.uid,
          image: this.user.photoURL,
          location: location,
          createdAt: now,
          index: -now  /* because reverse sorting firebase data is hard */
        });
    }.bind(this));
  },

  _firebaseDeleteMessage: function(post, channel) {
    firebase.database().ref('/posts/' + channel).child(post).remove();
  },

  _firebaseAddUsers: function(ref, newUsers) {
    this.$.newChannel.hide();

    // Add these users in the channels database
    firebase.database().ref('/channels/' + ref).once('value', function(snapshot) {
      var currentUsers = snapshot.val().users;
      currentUsers = currentUsers.concat(newUsers);
      snapshot.ref.update({users: currentUsers});
    });

    // For each of the users in the list, add this channel to them.
    firebase.database().ref('/users/').once('value', function(snapshot) {
      var users = snapshot.val();

      for (var user in users) {
        if (newUsers.indexOf(users[user].email) != -1 ) {
          var currentUserChannels = users[user].channels || [];
          currentUserChannels.push(ref);
          firebase.database().ref('/users/' + user).update({channels: currentUserChannels});
        }
      }
    });
  },

  _firebaseDeleteUsers: function(ref, delUsers) {
    this.$.newChannel.hide();

    // Remove these users in the channels database
    firebase.database().ref('/channels/' + ref).once('value', function(snapshot) {
      var currentUsers = snapshot.val().users;

      for (var user in delUsers) {
        var index = currentUsers.indexOf(delUsers[user]);
        if (index != -1 ) {
          currentUsers.splice(index, 1);
        }
      }
      snapshot.ref.update({users: currentUsers});
    });


    // For each of the users in the list, remove this channel from them.
    firebase.database().ref('/users/').once('value', function(snapshot) {
      var users = snapshot.val();

      for (var user in users) {
        if (delUsers.indexOf(users[user].email) != -1 ) {
          var currentUserChannels = users[user].channels || [];
          var channelIndex = currentUserChannels.indexOf(ref);
          currentUserChannels.splice(channelIndex, 1);
          firebase.database().ref('/users/' + user).update({channels: currentUserChannels});
        }
      }
    });
  },

  /*******************************
  * NOTIFICATIONS
  *******************************/

  _firebaseSendNotification: function(currentUser, sendToUID, activityID, type) {
    const dbRef = firebase.database().ref('/users/' + sendToUID).child('notifications');
    let now = new Date().getTime();
    const user = {name: currentUser.displayName, photoURL: currentUser.photoURL, userID: currentUser.uid};
    const note = { user: user, activity: activityID, sentOn: now, type: type};
    dbRef.push().set(note);
  },

  _firebaseDeleteNotification: function(currentUser, notificationID) {
    firebase.database().ref(`/users/${currentUser}/notifications`).child(notificationID).remove();
  },

  /*******************************
  * CHATS
  *******************************/

  _firebaseCreateChat: function(currentUser, otherUser) {
    const dbRef = firebase.database().ref('/chats/');
    const userList = {user1: currentUser, user2: otherUser};
    const chat = {users: userList};
    dbRef.push().set(chat);
  },

  _firebaseDeleteChat: function(key) {
    firebase.database().ref(`/chats/${key}`).remove();
  },

  _firebaseSendChat: function(id, user, message) {
    const dbRef = firebase.database().ref(`/chats/${id}/chats`);
    let now = new Date().getTime();
    const chat = {text: message, timeSent: now, userSent: user};
    dbRef.push().set(chat);
  }
};
</script>
